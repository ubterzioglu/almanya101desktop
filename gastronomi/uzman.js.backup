// =====================================================
// PROVIDERS.JS - Public UI Logic
// Turkish Doctor & Lawyer Directory
// =====================================================

// Supabase Configuration
// Replace with your actual Supabase URL and ANON KEY
const SUPABASE_URL = 'https://ldptefnpiudquipdsezr.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkcHRlZm5waXVkcXVpcGRzZXpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwNTg5MDYsImV4cCI6MjA4MjYzNDkwNn0.SjeCmVUhEWpPxkGojaGh6qSOwr8EbZx1Tq_ntpvaLnc';

// Initialize Supabase client (using window to avoid redeclaration errors)
window.sbClient = window.sbClient || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const supabase = window.sbClient;

// German cities list (static for MVP)
const GERMAN_CITIES = [
  'Berlin', 'Hamburg', 'MÃ¼nchen', 'KÃ¶ln', 'Frankfurt am Main',
  'Stuttgart', 'DÃ¼sseldorf', 'Dortmund', 'Essen', 'Leipzig',
  'Bremen', 'Dresden', 'Hannover', 'NÃ¼rnberg', 'Duisburg',
  'Bochum', 'Wuppertal', 'Bielefeld', 'Bonn', 'MÃ¼nster',
  'Karlsruhe', 'Mannheim', 'Augsburg', 'Wiesbaden', 'Gelsenkirchen',
  'MÃ¶nchengladbach', 'Braunschweig', 'Chemnitz', 'Kiel', 'Aachen'
].sort();

// State
let currentType = 'doctor';
let currentCity = '';
let selectedTags = [];
let allTags = [];
let allProviders = [];

// =====================================================
// INITIALIZATION
// =====================================================
document.addEventListener('DOMContentLoaded', () => {
  initTypeSelector();
  initCitySelector();
  initInfoToggle();
  initSubmitForm();
  initSearch();
  loadTags();
});

// =====================================================
// TYPE SELECTOR
// =====================================================
function initTypeSelector() {
  const typeOptions = document.querySelectorAll('.type-option');

  typeOptions.forEach(option => {
    option.addEventListener('click', () => {
      // Remove selected class from all
      typeOptions.forEach(opt => opt.classList.remove('selected'));

      // Add selected class to clicked
      option.classList.add('selected');

      // Update current type
      currentType = option.dataset.type;

      // Reset selections
      selectedTags = [];

      // Reload tags and providers
      loadTags();
      loadProviders();
    });
  });
}

// =====================================================
// CITY SELECTOR
// =====================================================
function initCitySelector() {
  const citySelect = document.getElementById('citySelect');

  // Populate cities
  GERMAN_CITIES.forEach(city => {
    const option = document.createElement('option');
    option.value = city;
    option.textContent = city;
    citySelect.appendChild(option);
  });

  // Listen for changes
  citySelect.addEventListener('change', (e) => {
    currentCity = e.target.value;
    loadProviders();
  });
}

// =====================================================
// INFO TOGGLE
// =====================================================
function initInfoToggle() {
  const toggleBtn = document.getElementById('infoToggle');
  const content = document.getElementById('infoContent');

  toggleBtn.addEventListener('click', () => {
    const isHidden = content.classList.contains('hidden');

    if (isHidden) {
      content.classList.remove('hidden');
      content.setAttribute('aria-hidden', 'false');
      toggleBtn.textContent = 'ğŸ“‹ Bilgi Kapat';
    } else {
      content.classList.add('hidden');
      content.setAttribute('aria-hidden', 'true');
      toggleBtn.textContent = 'ğŸ“‹ Bilgi AÃ§';
    }
  });
}

// =====================================================
// TAGS
// =====================================================
async function loadTags() {
  try {
    // Fetch tags for current type or common
    const { data, error } = await supabase
      .from('tags')
      .select('*')
      .in('type', [currentType, 'common'])
      .order('label');

    if (error) throw error;

    allTags = data || [];
    renderTags();
  } catch (error) {
    console.error('Error loading tags:', error);
    allTags = [];
    renderTags();
  }
}

function renderTags() {
  const container = document.getElementById('tagContainer');
  const section = document.getElementById('tagFilterSection');
  const clearBtn = document.getElementById('clearTagsBtn');

  if (allTags.length === 0) {
    section.classList.add('hidden');
    return;
  }

  section.classList.remove('hidden');
  container.innerHTML = '';

  allTags.forEach(tag => {
    const chip = document.createElement('div');
    chip.className = 'tag-chip';
    chip.textContent = tag.label;
    chip.dataset.tagId = tag.id;

    // Check if selected
    if (selectedTags.includes(tag.id)) {
      chip.classList.add('selected');
    }

    chip.addEventListener('click', () => {
      toggleTag(tag.id);
      chip.classList.toggle('selected');
      updateClearButton();
      loadProviders();
    });

    container.appendChild(chip);
  });

  updateClearButton();

  // Clear button handler
  clearBtn.addEventListener('click', () => {
    selectedTags = [];
    renderTags();
    loadProviders();
  });
}

function toggleTag(tagId) {
  const index = selectedTags.indexOf(tagId);

  if (index > -1) {
    selectedTags.splice(index, 1);
  } else {
    selectedTags.push(tagId);
  }
}

function updateClearButton() {
  const clearBtn = document.getElementById('clearTagsBtn');

  if (selectedTags.length > 0) {
    clearBtn.style.display = 'block';
  } else {
    clearBtn.style.display = 'none';
  }
}

// =====================================================
// PROVIDERS
// =====================================================
async function loadProviders() {
  const listContainer = document.getElementById('providersList');
  const resultsCount = document.getElementById('resultsCount');

  // Show loading
  listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6B7280;">YÃ¼kleniyor...</div>';

  // Check if city is selected
  if (!currentCity) {
    listContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ™ï¸</div>
        <p style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">LÃ¼tfen bir ÅŸehir seÃ§in</p>
        <p style="font-size: 14px;">Ãœstteki menÃ¼den ÅŸehrinizi seÃ§erek baÅŸlayÄ±n.</p>
      </div>
    `;
    resultsCount.textContent = '0 sonuÃ§ bulundu';
    return;
  }

  try {
    // Base query
    let query = supabase
      .from('providers')
      .select(`
        *,
        provider_tags(tag_id)
      `)
      .eq('type', currentType)
      .eq('city', currentCity)
      .eq('status', 'active');

    // Execute query
    const { data, error } = await query;

    if (error) throw error;

    allProviders = data || [];

    // Filter by tags if selected (OR logic: at least one tag match)
    let filteredProviders = allProviders;

    if (selectedTags.length > 0) {
      filteredProviders = allProviders.filter(provider => {
        const providerTagIds = provider.provider_tags.map(pt => pt.tag_id);
        return selectedTags.some(tagId => providerTagIds.includes(tagId));
      });
    }

    // Filter by search input
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    if (searchTerm) {
      filteredProviders = filteredProviders.filter(provider =>
        provider.display_name.toLowerCase().includes(searchTerm)
      );
    }

    // Sort by rating desc (nulls last), then by review count desc
    filteredProviders.sort((a, b) => {
      // Handle null ratings
      if (a.google_rating === null && b.google_rating === null) {
        return (b.google_user_ratings_total || 0) - (a.google_user_ratings_total || 0);
      }
      if (a.google_rating === null) return 1;
      if (b.google_rating === null) return -1;

      // Compare ratings
      if (b.google_rating !== a.google_rating) {
        return b.google_rating - a.google_rating;
      }

      // If ratings equal, compare review counts
      return (b.google_user_ratings_total || 0) - (a.google_user_ratings_total || 0);
    });

    // Update count
    resultsCount.textContent = `${filteredProviders.length} sonuÃ§ bulundu`;

    // Render providers
    if (filteredProviders.length === 0) {
      renderEmptyState();
    } else {
      renderProviders(filteredProviders);
    }

  } catch (error) {
    console.error('Error loading providers:', error);
    listContainer.innerHTML = `
      <div class="error-message">
        Bir hata oluÅŸtu. LÃ¼tfen daha sonra tekrar deneyin.
      </div>
    `;
  }
}

function renderEmptyState() {
  const listContainer = document.getElementById('providersList');

  listContainer.innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ”</div>
      <p style="font-size: 15px; font-weight: 600; margin-bottom: 8px;">Bu ÅŸehirde henÃ¼z kayÄ±t yok</p>
      <p style="font-size: 14px;">Ä°lk sen Ã¶ner! AÅŸaÄŸÄ±daki "KayÄ±t Ã–ner" formunu kullanabilirsin.</p>
    </div>
  `;
}

function renderProviders(providers) {
  const listContainer = document.getElementById('providersList');
  listContainer.innerHTML = '';

  providers.forEach(provider => {
    const card = createProviderCard(provider);
    listContainer.appendChild(card);
  });
}

function createProviderCard(provider) {
  const card = document.createElement('div');
  card.className = 'provider-card';

  // Provider name
  const name = document.createElement('div');
  name.className = 'provider-name';
  name.textContent = provider.display_name;
  card.appendChild(name);

  // Rating (if available)
  if (provider.google_rating) {
    const rating = document.createElement('div');
    rating.className = 'provider-rating';
    rating.innerHTML = `
      â­ ${provider.google_rating.toFixed(1)}
      ${provider.google_user_ratings_total ? `(${provider.google_user_ratings_total} deÄŸerlendirme)` : ''}
    `;
    card.appendChild(rating);
  }

  // Tags
  if (provider.provider_tags && provider.provider_tags.length > 0) {
    const tagsContainer = document.createElement('div');
    tagsContainer.className = 'tag-container';
    tagsContainer.style.marginBottom = '10px';

    provider.provider_tags.forEach(pt => {
      const tag = allTags.find(t => t.id === pt.tag_id);
      if (tag) {
        const chip = document.createElement('div');
        chip.className = 'tag-chip';
        chip.style.cursor = 'default';
        chip.textContent = tag.label;
        tagsContainer.appendChild(chip);
      }
    });

    card.appendChild(tagsContainer);
  }

  // Address
  if (provider.address) {
    const address = document.createElement('div');
    address.className = 'provider-address';
    address.textContent = provider.address;
    card.appendChild(address);
  }

  // Actions
  const actions = document.createElement('div');
  actions.className = 'provider-actions';

  // Google Maps button
  if (provider.google_maps_url) {
    const mapsBtn = document.createElement('a');
    mapsBtn.href = provider.google_maps_url;
    mapsBtn.target = '_blank';
    mapsBtn.rel = 'noopener noreferrer';
    mapsBtn.className = 'btn-maps';
    mapsBtn.textContent = 'Google\'da AÃ§';
    actions.appendChild(mapsBtn);
  }

  // Detail button (could expand inline or show modal)
  const detailBtn = document.createElement('button');
  detailBtn.className = 'btn-detail';
  detailBtn.textContent = 'Detay';
  detailBtn.addEventListener('click', () => showProviderDetail(provider));
  actions.appendChild(detailBtn);

  card.appendChild(actions);

  return card;
}

function showProviderDetail(provider) {
  // Simple alert for MVP - can be replaced with modal
  let details = `${provider.display_name}\n\n`;

  if (provider.address) details += `Adres: ${provider.address}\n`;
  if (provider.phone) details += `Telefon: ${provider.phone}\n`;
  if (provider.website) details += `Website: ${provider.website}\n`;
  if (provider.notes_public) details += `\nNot: ${provider.notes_public}\n`;

  alert(details);
}

// =====================================================
// SEARCH
// =====================================================
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  let searchTimeout;

  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      loadProviders();
    }, 300);
  });
}

// =====================================================
// SUBMIT FORM
// =====================================================
function initSubmitForm() {
  const form = document.getElementById('submitForm');
  const submitBtn = document.getElementById('submitBtn');
  const messageDiv = document.getElementById('submitMessage');

  // Set default submit type to current selected type
  document.getElementById('submitType').value = currentType;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading-spinner"></span> GÃ¶nderiliyor...';

    // Clear previous messages
    messageDiv.innerHTML = '';

    try {
      // Collect form data
      const formData = {
        type: document.getElementById('submitType').value,
        display_name: document.getElementById('submitName').value.trim(),
        city: document.getElementById('submitCity').value.trim(),
        address: document.getElementById('submitAddress').value.trim() || null,
        phone: document.getElementById('submitPhone').value.trim() || null,
        website: document.getElementById('submitWebsite').value.trim() || null,
        google_maps_url: document.getElementById('submitMapsUrl').value.trim() || null,
        google_place_id: document.getElementById('submitPlaceId').value.trim() || null,
        note: document.getElementById('submitNote').value.trim() || null,
        status: 'pending'
      };

      // Parse tags
      const tagsInput = document.getElementById('submitTags').value.trim();
      if (tagsInput) {
        formData.tag_labels = tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0);
      }

      // Get current user ID if authenticated (optional)
      const { data: { user } } = await supabase.auth.getUser();
      if (user) {
        formData.submitter_user_id = user.id;
      }

      // Insert submission
      const { data, error } = await supabase
        .from('provider_submissions')
        .insert([formData])
        .select();

      if (error) throw error;

      // Show success message
      messageDiv.innerHTML = `
        <div class="success-message">
          âœ… TeÅŸekkÃ¼rler! Ã–neriniz baÅŸarÄ±yla alÄ±ndÄ±. Admin onayÄ± sonrasÄ± yayÄ±na alÄ±nacak.
        </div>
      `;

      // Reset form
      form.reset();
      document.getElementById('submitType').value = currentType;

      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    } catch (error) {
      console.error('Error submitting provider:', error);

      messageDiv.innerHTML = `
        <div class="error-message">
          âŒ Bir hata oluÅŸtu. LÃ¼tfen daha sonra tekrar deneyin.
        </div>
      `;
    } finally {
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = 'GÃ¶nder';
    }
  });
}
