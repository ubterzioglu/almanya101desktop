<!doctype html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../img/icons/headericon.png" />
  <title>Developer Toplulu&#287;u - almanya101</title>
  <meta name="title" content="Developer Toplulu&#287;u - almanya101">
  <meta name="description"
    content="Almanya'da ya&#351;ayan T&#252;rk developer, QA, DevOps ve tech profesyonellerini ke&#351;fet.">
  <meta name="robots" content="noindex, nofollow">

  <link rel="stylesheet" href="devuserlist.css" />
</head>

<body>
  <div class="container1" id="authGate">
    <div class="card hero-card1">
      <div class="hero-domain1">almanya101.de</div>
      <h3>Giri&#351; Gerekli</h3>
      <p style="margin: 10px 0 0 0;">Devuser listesini g&#246;rmek i&#231;in onayl&#305; hesab&#305;n&#305;zla giri&#351; yap&#305;n.</p>
    </div>

    <div class="card auth-card">
      <div class="auth-grid">
        <input type="email" id="authEmail" placeholder="Email adresiniz" autocomplete="email" />
        <input type="password" id="authPassword" placeholder="&#350;ifreniz" autocomplete="current-password" />
      </div>

      <div class="auth-actions">
        <button class="btn btn-primary" id="emailSignInBtn" type="button">E-posta ile giri&#351;</button>
      </div>

      <p class="auth-note">Sadece admin onayl&#305; &#252;yeler arama ekran&#305;na eri&#351;ebilir.</p>
      <p class="auth-status" id="authStatusText"></p>
    </div>
  </div>

  <div class="container1" id="protectedContent" style="display:none;">
    <div class="card hero-card1">
      <div class="hero-domain1">almanya101.de</div>
      <h3>Arama Yap</h3>
    </div>

    <div class="card account-card">
      <div class="account-row">
        <div>
          <div style="font-size: 12px; color: rgba(255,255,255,.65);">Aktif oturum</div>
          <div id="activeAccountEmail" style="font-weight: 700; margin-top: 4px;">-</div>
        </div>
        <div class="account-actions">
          <button type="button" class="btn btn-secondary" id="editProfileBtn">Profil Düzenle</button>
          <button type="button" class="btn btn-secondary" id="logoutBtn">&#199;&#305;k&#305;&#351;</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h4 style="margin-top: 0; color: #F65314;">Ara</h4>

      <!-- Search Bar - Always at Top -->
      <div class="search-bar-container">
        <div class="filter-group">
          <label>Anahtar Kelime</label>
          <input type="text" id="keywordSearch" placeholder="Ad, &#351;ehir, rol, teknoloji, ilgi alan&#305;...">
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-group">
          <label>H&#305;zl&#305; Filtreler</label>
          <div class="checkbox-filter-row">
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox" id="filterActiveJob">
              <span>Aktif i&#351; ar&#305;yor</span>
            </label>
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox" id="filterFreelance">
              <span>Freelance a&#231;&#305;k</span>
            </label>
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox" id="filterMentor">
              <span>Mentorluk verebilir</span>
            </label>
          </div>
        </div>

        <div class="filter-group">
          <label>Deneyim Seviyesi</label>
          <div class="checkbox-filter-row">
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox exp-filter-checkbox" value="0-1">
              <span>0-1 y&#305;l</span>
            </label>
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox exp-filter-checkbox" value="1-3">
              <span>1-3 y&#305;l</span>
            </label>
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox exp-filter-checkbox" value="3-5">
              <span>3-5 y&#305;l</span>
            </label>
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox exp-filter-checkbox" value="5-10">
              <span>5-10 y&#305;l</span>
            </label>
            <label class="checkbox-filter-item">
              <input type="checkbox" class="quick-filter-checkbox exp-filter-checkbox" value="10+">
              <span>10+ y&#305;l</span>
            </label>
          </div>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-primary" id="searchBtn">Ara</button>
      </div>
    </div>

    <div class="results-count-card" id="resultsCountCard" style="display: none;">
      <h4>Topluluk &#220;yeleri</h4>
      <span class="results-count" id="resultsCount"></span>
    </div>

    <div class="loading" id="loadingState">
      <p>&#220;yeler y&#252;kleniyor...</p>
    </div>

    <div class="user-grid hidden" id="userGrid"></div>

    <div class="empty-state hidden" id="emptyState">
      <h4>Sonu&#231; bulunamad&#305;</h4>
      <p>Filtreleri de&#287;i&#351;tirerek tekrar deneyin.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script type="module">
    const USERS_API_URL = '/api/devuser-list';

    const authGate = document.getElementById('authGate');
    const protectedContent = document.getElementById('protectedContent');
    const authStatusText = document.getElementById('authStatusText');
    const activeAccountEmail = document.getElementById('activeAccountEmail');

    const emailInput = document.getElementById('authEmail');
    const passwordInput = document.getElementById('authPassword');

    const emailSignInBtn = document.getElementById('emailSignInBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');

    const searchBtn = document.getElementById('searchBtn');
    const keywordSearchInput = document.getElementById('keywordSearch');
    const filterActiveJobInput = document.getElementById('filterActiveJob');
    const filterFreelanceInput = document.getElementById('filterFreelance');
    const filterMentorInput = document.getElementById('filterMentor');
    const expFilterInputs = Array.from(document.querySelectorAll('.exp-filter-checkbox'));
    const quickFilterInputs = Array.from(document.querySelectorAll('.quick-filter-checkbox'));

    let supabaseClient = null;
    let allUsers = [];
    let usersLoaded = false;
    let activeSessionUserId = '';
    const REQUEST_TIMEOUT_MS = 12000;

    function setAuthStatus(message, type = '') {
      authStatusText.textContent = message;
      authStatusText.className = `auth-status ${type}`.trim();
    }

    function getSupabaseClient() {
      if (supabaseClient) return supabaseClient;

      const cfg = window.ALMANYA101_SUPABASE || {};
      if (!window.supabase || !cfg.url || !cfg.anonKey) {
        throw new Error('Supabase config eksik.');
      }

      supabaseClient = window.supabase.createClient(cfg.url, cfg.anonKey, {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
        },
      });
      return supabaseClient;
    }

    function showProtected(session) {
      authGate.style.display = 'none';
      protectedContent.style.display = 'block';
      activeAccountEmail.textContent = session?.user?.email || '-';
    }

    function resetProtectedUi() {
      const loadingState = document.getElementById('loadingState');
      const userGrid = document.getElementById('userGrid');
      const emptyState = document.getElementById('emptyState');
      const resultsCountCard = document.getElementById('resultsCountCard');
      const resultsCount = document.getElementById('resultsCount');

      if (loadingState) {
        loadingState.classList.remove('hidden');
        loadingState.style.color = '';
        loadingState.textContent = '\u00dcyeler y\u00fckleniyor...';
      }
      if (userGrid) {
        userGrid.classList.add('hidden');
        userGrid.innerHTML = '';
      }
      if (emptyState) {
        emptyState.classList.add('hidden');
      }
      if (resultsCountCard) {
        resultsCountCard.style.display = 'none';
      }
      if (resultsCount) {
        resultsCount.textContent = '';
      }
    }

    function showAuthGate() {
      usersLoaded = false;
      allUsers = [];
      activeSessionUserId = '';
      activeAccountEmail.textContent = '-';
      resetProtectedUi();
      protectedContent.style.display = 'none';
      authGate.style.display = 'block';
    }

    async function getSessionToken() {
      const client = getSupabaseClient();
      const { data, error } = await client.auth.getSession();
      if (error || !data.session) return null;
      return data.session.access_token;
    }

    function withTimeout(promise, timeoutMs = REQUEST_TIMEOUT_MS, timeoutMessage = '\u0130stek zaman a\u015f\u0131m\u0131na u\u011frad\u0131.') {
      let timerId = null;

      const timeoutPromise = new Promise((_, reject) => {
        timerId = window.setTimeout(() => {
          reject(new Error(timeoutMessage));
        }, timeoutMs);
      });

      return Promise.race([promise, timeoutPromise]).finally(() => {
        if (timerId) {
          window.clearTimeout(timerId);
        }
      });
    }

    async function fetchUsersWithToken(token) {
      const response = await withTimeout(
        fetch(USERS_API_URL, {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }),
        REQUEST_TIMEOUT_MS,
        'Kullan\u0131c\u0131 listesi zaman a\u015f\u0131m\u0131na u\u011frad\u0131.'
      );

      if (response.status === 401) {
        return { ok: false, unauthorized: true, data: null };
      }

      if (response.status === 403) {
        const payload = await response.json().catch(() => ({}));
        return { ok: false, unauthorized: false, forbidden: true, payload, data: null };
      }

      const payload = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(payload.error || `HTTP ${response.status}`);
      }

      return { ok: true, unauthorized: false, data: payload.data || [] };
    }

    async function loadUsers() {
      const loadingState = document.getElementById('loadingState');
      usersLoaded = false;
      loadingState.classList.remove('hidden');
      loadingState.style.color = '';
      loadingState.textContent = '\u00dcyeler y\u00fckleniyor...';

      try {
        const token = await getSessionToken();
        if (!token) {
          showAuthGate();
          return { ok: false, reason: 'auth' };
        }

        let result = await fetchUsersWithToken(token);
        if (result.forbidden) {
          await signOutSilently();
          setAuthStatus(result.payload?.error || 'Kayd\u0131n\u0131z admin onay\u0131 bekliyor.', 'error');
          return { ok: false, reason: 'auth' };
        }

        if (result.unauthorized) {
          const refreshedToken = await getSessionToken();
          if (!refreshedToken) {
            showAuthGate();
            setAuthStatus('Oturum s\u00fcresi doldu. L\u00fctfen tekrar giri\u015f yap\u0131n.', 'error');
            return { ok: false, reason: 'auth' };
          }
          result = await fetchUsersWithToken(refreshedToken);
          if (result.forbidden) {
            await signOutSilently();
            setAuthStatus(result.payload?.error || 'Kayd\u0131n\u0131z admin onay\u0131 bekliyor.', 'error');
            return { ok: false, reason: 'auth' };
          }
          if (result.unauthorized) {
            showAuthGate();
            setAuthStatus('Oturum s\u00fcresi doldu. L\u00fctfen tekrar giri\u015f yap\u0131n.', 'error');
            return { ok: false, reason: 'auth' };
          }
        }

        allUsers = result.data;
        runKeywordFilter();
        usersLoaded = true;
        return { ok: true, reason: 'ok' };
      } catch (error) {
        console.error('User load failed:', error);
        loadingState.textContent = 'Y\u00fckleme hatas\u0131. L\u00fctfen sayfay\u0131 yenileyin.';
        loadingState.style.color = '#ff4d4f';
        return { ok: false, reason: 'error' };
      }
    }

    function readEmailPassword() {
      const email = emailInput.value.trim().toLowerCase();
      const password = passwordInput.value;

      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        throw new Error('Ge\u00e7erli bir e-posta girin.');
      }

      if (password.length < 6) {
        throw new Error('\u015eifre en az 6 karakter olmal\u0131.');
      }

      return { email, password };
    }

    async function signInWithPassword() {
      try {
        const { email, password } = readEmailPassword();
        setAuthStatus('Giri\u015f yap\u0131l\u0131yor...');

        const client = getSupabaseClient();
        const { error } = await withTimeout(
          client.auth.signInWithPassword({ email, password }),
          REQUEST_TIMEOUT_MS,
          'Giri\u015f s\u00fcresi a\u015f\u0131ld\u0131. L\u00fctfen tekrar deneyin.'
        );
        if (error) {
          throw error;
        }

        setAuthStatus('Giri\u015f ba\u015far\u0131l\u0131.', 'success');
      } catch (error) {
        setAuthStatus(error.message || 'Giri\u015f yap\u0131lamad\u0131.', 'error');
      }
    }

    async function signOut() {
      const client = getSupabaseClient();
      await client.auth.signOut();
      showAuthGate();
      setAuthStatus('\u00c7\u0131k\u0131\u015f yap\u0131ld\u0131.');
      location.reload();
    }

    async function signOutSilently() {
      try {
        const client = getSupabaseClient();
        await client.auth.signOut();
      } catch {
        // no-op
      }
      showAuthGate();
    }

    function displayUsers(users) {
      const loadingState = document.getElementById('loadingState');
      const userGrid = document.getElementById('userGrid');
      const emptyState = document.getElementById('emptyState');
      const resultsCount = document.getElementById('resultsCount');
      const resultsCountCard = document.getElementById('resultsCountCard');

      loadingState.classList.add('hidden');

      if (users.length === 0) {
        userGrid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        resultsCountCard.style.display = 'none';
        return;
      }

      emptyState.classList.add('hidden');
      userGrid.classList.remove('hidden');
      resultsCountCard.style.display = 'block';
      resultsCount.textContent = `${users.length} üye`;

      userGrid.innerHTML = users.map((user) => createUserCard(user)).join('');
    }

    function createUserCard(user) {
      const techStack = [
        ...(user.programlama_dilleri || []),
        ...(user.framework_platformlar || []),
        ...(user.devops_cloud || []),
      ].slice(0, 8);

      const badges = [];
      if (user.is_arama_durumu === 'Evet, aktif') {
        badges.push('<span class="badge badge-green">Aktif i\u015f ar\u0131yor</span>');
      } else if (user.is_arama_durumu === 'Evet, pasif (firsat olursa)') {
        badges.push('<span class="badge">Pasif i\u015f ar\u0131yor</span>');
      }
      if (user.freelance_aciklik && user.freelance_aciklik !== 'Hayir') {
        badges.push('<span class="badge">Freelance a\u00e7\u0131k</span>');
      }
      if (user.profesyonel_destek_verebilir) {
        badges.push('<span class="badge">Mentorluk verebilir</span>');
      }

      const safeLinkedinUrl = getSafeLinkedInUrl(user.linkedin_url);
      const safeWhatsappUrl = user.whatsapp_tel && user.iletisim_izni
        ? getSafeWhatsappUrl(user.whatsapp_tel)
        : null;

      const linkedinBtn = safeLinkedinUrl
        ? `<a href="${escapeHtml(safeLinkedinUrl)}" target="_blank" rel="noopener noreferrer nofollow" referrerpolicy="no-referrer" class="action-btn">LinkedIn</a>`
        : '';

      const whatsappBtn = safeWhatsappUrl
        ? `<a href="${escapeHtml(safeWhatsappUrl)}" target="_blank" rel="noopener noreferrer nofollow" referrerpolicy="no-referrer" class="action-btn">WhatsApp</a>`
        : '';

      return `
        <div class="user-card">
          <div class="user-card-main">
            <div class="user-card-left">
              <div class="user-header">
                <div>
                  <h3 class="user-name">${escapeHtml(user.ad_soyad)}</h3>
                  <div class="user-role">${escapeHtml(user.rol || 'Developer')}</div>
                </div>
              </div>

              ${badges.length > 0 ? `<div class="user-badges">${badges.join('')}</div>` : ''}

              <div class="user-info">
                ${user.sehir ? `<div class="info-row"><span class="info-icon">[S]</span> ${escapeHtml(user.sehir)}</div>` : ''}
                ${user.deneyim_seviye ? `<div class="info-row"><span class="info-icon">[D]</span> ${escapeHtml(user.deneyim_seviye)} deneyim</div>` : ''}
                ${user.almanya_yasam ? `<div class="info-row"><span class="info-icon">[DE]</span> Almanya'da ya\u015f\u0131yor</div>` : ''}
              </div>
            </div>

            <div class="user-card-right">
              ${user.guclu_alanlar && user.guclu_alanlar.length > 0 ? `
                <div class="section-title">G\u00fc\u00e7l\u00fc Alanlar</div>
                <div class="tech-tags">
                  ${user.guclu_alanlar.slice(0, 5).map((alan) => `<span class="tech-tag">${escapeHtml(alan)}</span>`).join('')}
                </div>
              ` : ''}

              ${techStack.length > 0 ? `
                <div class="section-title">Teknoloji Stack</div>
                <div class="tech-tags">
                  ${techStack.map((tech) => `<span class="tech-tag">${escapeHtml(tech)}</span>`).join('')}
                </div>
              ` : ''}

              ${user.ilgi_konular && user.ilgi_konular.length > 0 ? `
                <div class="section-title">\u0130lgi Alanlar\u0131</div>
                <div class="tech-tags">
                  ${user.ilgi_konular.slice(0, 4).map((ilgi) => `<span class="tech-tag">${escapeHtml(ilgi)}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          </div>

          ${linkedinBtn || whatsappBtn ? `
            <div class="user-actions">
              ${linkedinBtn}
              ${whatsappBtn}
            </div>
          ` : ''}
        </div>
      `;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = typeof text === 'string' ? text : String(text ?? '');
      return div.innerHTML;
    }

    function getSafeLinkedInUrl(rawUrl) {
      if (typeof rawUrl !== 'string' || !rawUrl.trim()) return null;
      try {
        const url = new URL(rawUrl.trim());
        const hostname = url.hostname.toLowerCase();
        const isLinkedInHost = hostname === 'linkedin.com' || hostname === 'www.linkedin.com' || hostname.endsWith('.linkedin.com');
        const isHttp = url.protocol === 'https:' || url.protocol === 'http:';
        if (!isLinkedInHost || !isHttp) return null;
        return url.toString();
      } catch {
        return null;
      }
    }

    function getSafeWhatsappUrl(rawPhone) {
      if (typeof rawPhone !== 'string') return null;
      const digits = rawPhone.replace(/[^0-9]/g, '');
      if (digits.length < 8 || digits.length > 15) return null;
      return `https://wa.me/${digits}`;
    }

    function normalizeText(value) {
      return String(value || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9,+\s()-]/g, '')
        .trim();
    }

    function getExperienceBucket(value) {
      const text = normalizeText(value);
      if (!text) return '';
      if (/\b10\s*\+/.test(text)) return '10+';
      if (/\b5\s*-\s*10\b/.test(text)) return '5-10';
      if (/\b3\s*-\s*5\b/.test(text)) return '3-5';
      if (/\b1\s*-\s*3\b/.test(text)) return '1-3';
      if (/\b0\s*-\s*1\b/.test(text)) return '0-1';
      return '';
    }

    function readQuickFilterState() {
      const selectedExperience = expFilterInputs
        .filter((input) => input.checked)
        .map((input) => input.value);

      return {
        activeJob: Boolean(filterActiveJobInput?.checked),
        freelance: Boolean(filterFreelanceInput?.checked),
        mentor: Boolean(filterMentorInput?.checked),
        selectedExperience,
      };
    }

    function matchesQuickFilters(user, filterState) {
      if (filterState.activeJob) {
        const isAramaDurumu = normalizeText(user.is_arama_durumu);
        if (!isAramaDurumu.includes('evet aktif')) {
          return false;
        }
      }

      if (filterState.freelance) {
        const freelanceText = normalizeText(user.freelance_aciklik);
        if (!freelanceText || /^hay/.test(freelanceText)) {
          return false;
        }
      }

      if (filterState.mentor && !user.profesyonel_destek_verebilir) {
        return false;
      }

      if (filterState.selectedExperience.length > 0) {
        const userBucket = getExperienceBucket(user.deneyim_seviye);
        if (!filterState.selectedExperience.includes(userBucket)) {
          return false;
        }
      }

      return true;
    }

    function runKeywordFilter() {
      const keyword = normalizeText(keywordSearchInput.value);
      const tokens = keyword ? keyword.split(/[\s,]+/).map((item) => item.trim()).filter(Boolean) : [];
      const filterState = readQuickFilterState();

      const filtered = allUsers.filter((user) => {
        if (!matchesQuickFilters(user, filterState)) {
          return false;
        }

        if (tokens.length === 0) {
          return true;
        }

        const haystack = normalizeText([
          user.ad_soyad,
          user.sehir,
          user.rol,
          user.deneyim_seviye,
          user.is_arama_durumu,
          ...(user.guclu_alanlar || []),
          ...(user.programlama_dilleri || []),
          ...(user.framework_platformlar || []),
          ...(user.devops_cloud || []),
          ...(user.ilgi_konular || []),
          ...(user.ogrenmek_istenen || []),
          ...(user.kullanilan_ide || []),
          ...(user.kullanilan_agent || []),
        ].join(' '));

        return tokens.every((token) => haystack.includes(token));
      });

      displayUsers(filtered);
    }

    async function initAuth() {
      try {
        const client = getSupabaseClient();

        const handleAuthStateChange = async (session) => {
          if (!session) {
            showAuthGate();
            return;
          }

          const nextUserId = String(session?.user?.id || '');
          if (activeSessionUserId && activeSessionUserId !== nextUserId) {
            usersLoaded = false;
            allUsers = [];
          }
          activeSessionUserId = nextUserId;

          const loadResult = await loadUsers();
          if (loadResult.ok || loadResult.reason === 'error') {
            showProtected(session);
          }
        };

        client.auth.onAuthStateChange((_event, session) => {
          // Async work must not block auth lifecycle callbacks.
          void handleAuthStateChange(session);
        });

        const { data, error } = await client.auth.getSession();
        if (error || !data.session) {
          showAuthGate();
          return;
        }

        activeSessionUserId = String(data.session?.user?.id || '');
        const loadResult = await loadUsers();
        if (loadResult.ok || loadResult.reason === 'error') {
          showProtected(data.session);
        }
      } catch (error) {
        setAuthStatus(error.message || 'Auth ba\u015flat\u0131lamad\u0131.', 'error');
        showAuthGate();
      }
    }

    emailSignInBtn.addEventListener('click', signInWithPassword);
    logoutBtn.addEventListener('click', signOut);

    editProfileBtn.addEventListener('click', () => {
      window.location.href = 'profile-edit.html';
    });

    emailInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        signInWithPassword();
      }
    });

    passwordInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        signInWithPassword();
      }
    });

    searchBtn.addEventListener('click', runKeywordFilter);
    keywordSearchInput.addEventListener('input', runKeywordFilter);
    quickFilterInputs.forEach((input) => {
      input.addEventListener('change', runKeywordFilter);
    });
    keywordSearchInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        runKeywordFilter();
      }
    });

    initAuth();
  </script>
</body>

</html>


