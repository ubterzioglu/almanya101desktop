<!doctype html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../img/icons/headericon.png" />
  <meta name="robots" content="noindex,nofollow" />
  <title>DevUser DIS Admin - almanya101</title>
  <link rel="stylesheet" href="devuseradmin.css" />
  <style>
    .topic-cell {
      min-width: 340px;
      max-width: 560px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.45;
    }

    .meta-line {
      display: block;
      margin-top: 6px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
    }

    .badge.approved {
      min-width: 94px;
    }

    .badge.pending {
      min-width: 94px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card hero">
      <div class="domain">almanya101.de</div>
      <h1>DevUser DIS Admin</h1>
    </div>

    <div class="card" id="loginCard">
      <div class="login-grid">
        <input class="input" id="adminKeyInput" type="password" placeholder="Admin key" autocomplete="off" />
        <button class="btn-primary" id="loginBtn" type="button">Panele Gir</button>
      </div>
      <div class="status" id="loginStatus"></div>
    </div>

    <div id="panel" style="display:none;">
      <div class="card">
        <div class="row" style="justify-content: space-between; align-items:center;">
          <strong>DIS admin oturumu a&#231;&#305;k</strong>
          <div class="row">
            <a class="btn-secondary" style="text-decoration:none; display:inline-flex; align-items:center;" href="dis.html">DIS Sayfas&#305;</a>
            <button class="btn-secondary" id="logoutBtn" type="button">&#199;&#305;k&#305;&#351;</button>
          </div>
        </div>
      </div>

      <div class="card stats">
        <div class="stat-box">
          <div class="stat-label">Toplam</div>
          <div class="stat-value" id="statTotal">-</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Pending</div>
          <div class="stat-value" id="statPending">-</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Approved</div>
          <div class="stat-value" id="statApproved">-</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Filtre Sonucu</div>
          <div class="stat-value" id="statFiltered">-</div>
        </div>
      </div>

      <div class="card">
        <div class="toolbar">
          <input class="input" id="searchInput" placeholder="Ara: ad veya konu..." />
          <button class="btn-primary" id="refreshBtn" type="button">Yenile</button>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Konu</th>
                <th>G&#246;nderen</th>
                <th>Durum</th>
                <th>Tarih</th>
                <th>Aksiyon</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr><td class="empty" colspan="5">Y&#252;kleniyor...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_KEY_STORAGE = 'devuser_dis_admin_key_v1';
    const LIST_API_URL = '/api/devuser-dis-admin-list';
    const ACTION_API_URL = '/api/devuser-dis-admin-action';

    const loginCard = document.getElementById('loginCard');
    const panel = document.getElementById('panel');
    const loginStatus = document.getElementById('loginStatus');
    const adminKeyInput = document.getElementById('adminKeyInput');
    const tableBody = document.getElementById('tableBody');
    const searchInput = document.getElementById('searchInput');

    let adminKey = '';
    let rows = [];
    let filteredRows = [];

    function setStatus(message, type = '') {
      loginStatus.textContent = message;
      loginStatus.className = `status ${type}`.trim();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = typeof text === 'string' ? text : String(text ?? '');
      return div.innerHTML;
    }

    function normalizeSearch(value) {
      return String(value || '').toLowerCase().trim();
    }

    function toDate(value) {
      if (!value) return '-';
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return '-';
      return d.toLocaleString('tr-TR');
    }

    function statusBadge(status) {
      const safe = String(status || 'pending').toLowerCase() === 'approved' ? 'approved' : 'pending';
      return `<span class="badge ${safe}">${safe}</span>`;
    }

    function apiHeaders() {
      return {
        'Content-Type': 'application/json',
        'x-admin-key': adminKey,
      };
    }

    async function apiGet(url) {
      const res = await fetch(url, {
        method: 'GET',
        headers: { 'x-admin-key': adminKey },
      });
      const payload = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(payload.error || `HTTP ${res.status}`);
      }
      return payload;
    }

    async function apiPost(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: apiHeaders(),
        body: JSON.stringify(body),
      });
      const payload = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(payload.error || `HTTP ${res.status}`);
      }
      return payload;
    }

    function updateStats(stats) {
      document.getElementById('statTotal').textContent = String(stats.total || 0);
      document.getElementById('statPending').textContent = String(stats.pending || 0);
      document.getElementById('statApproved').textContent = String(stats.approved || 0);
      document.getElementById('statFiltered').textContent = String(filteredRows.length);
    }

    function applyFilter() {
      const query = normalizeSearch(searchInput.value);
      if (!query) {
        filteredRows = [...rows];
      } else {
        const tokens = query.split(/\s+/).map((item) => item.trim()).filter(Boolean);
        filteredRows = rows.filter((item) => {
          const haystack = normalizeSearch([
            item.full_name || '',
            item.anonymous ? 'anonim' : '',
            item.topic || '',
            item.status || '',
          ].join(' '));
          return tokens.every((token) => haystack.includes(token));
        });
      }

      renderTable();
      updateStats({
        total: rows.length,
        pending: rows.filter((item) => item.status === 'pending').length,
        approved: rows.filter((item) => item.status === 'approved').length,
      });
    }

    function renderTable() {
      if (!filteredRows.length) {
        tableBody.innerHTML = '<tr><td class="empty" colspan="5">Kay&#305;t bulunamad&#305;.</td></tr>';
        return;
      }

      tableBody.innerHTML = filteredRows.map((item) => {
        const id = escapeHtml(item.id);
        const sender = item.anonymous ? 'Anonim' : (item.full_name || '-');
        const approved = String(item.status || '').toLowerCase() === 'approved';
        const pending = !approved;

        return `
          <tr>
            <td class="topic-cell">${escapeHtml(item.topic || '')}</td>
            <td>
              ${escapeHtml(sender)}
              ${item.anonymous ? '<span class="meta-line">anonim</span>' : ''}
            </td>
            <td>${statusBadge(item.status)}</td>
            <td>${escapeHtml(toDate(item.created_at))}</td>
            <td>
              <div class="actions">
                <button type="button" class="btn-primary" data-action="approve" data-id="${id}" ${approved ? 'disabled' : ''}>Onayla</button>
                <button type="button" class="btn-secondary" data-action="pending" data-id="${id}" ${pending ? 'disabled' : ''}>Beklemeye Al</button>
                <button type="button" class="btn-danger" data-action="delete" data-id="${id}">Sil</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function loadRows() {
      tableBody.innerHTML = '<tr><td class="empty" colspan="5">Y&#252;kleniyor...</td></tr>';
      const payload = await apiGet(`${LIST_API_URL}?status=all&limit=1000`);
      rows = Array.isArray(payload.items) ? payload.items : [];
      applyFilter();
    }

    async function refreshAll() {
      try {
        await loadRows();
      } catch (error) {
        tableBody.innerHTML = `<tr><td class="empty" colspan="5">${escapeHtml(error.message || 'Y\u00fckleme hatas\u0131')}</td></tr>`;
      }
    }

    async function login() {
      const key = adminKeyInput.value.trim();
      if (!key) {
        setStatus('Admin key girin.', 'error');
        return;
      }

      adminKey = key;
      setStatus('Ba\u011flant\u0131 kontrol ediliyor...');

      try {
        await apiGet(`${LIST_API_URL}?limit=1`);
        sessionStorage.setItem(ADMIN_KEY_STORAGE, adminKey);
        loginCard.style.display = 'none';
        panel.style.display = 'block';
        setStatus('');
        await refreshAll();
      } catch (error) {
        setStatus(error.message || 'Giri\u015f ba\u015far\u0131s\u0131z.', 'error');
      }
    }

    function logout() {
      sessionStorage.removeItem(ADMIN_KEY_STORAGE);
      adminKey = '';
      rows = [];
      filteredRows = [];
      panel.style.display = 'none';
      loginCard.style.display = 'block';
      adminKeyInput.value = '';
      tableBody.innerHTML = '<tr><td class="empty" colspan="5">Y&#252;kleniyor...</td></tr>';
      setStatus('\u00c7\u0131k\u0131\u015f yap\u0131ld\u0131.');
    }

    async function runAction(action, id) {
      if (!id) return;
      if (action === 'delete' && !window.confirm('Bu kay\u0131t silinsin mi?')) return;

      try {
        await apiPost(ACTION_API_URL, { action, id });
        await refreshAll();
      } catch (error) {
        window.alert(error.message || '\u0130\u015flem ba\u015far\u0131s\u0131z.');
      }
    }

    document.getElementById('loginBtn').addEventListener('click', login);
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('refreshBtn').addEventListener('click', refreshAll);
    searchInput.addEventListener('input', applyFilter);

    adminKeyInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        login();
      }
    });

    tableBody.addEventListener('click', (event) => {
      const button = event.target.closest('button[data-action]');
      if (!button) return;
      runAction(button.dataset.action, button.dataset.id);
    });

    (function init() {
      const saved = sessionStorage.getItem(ADMIN_KEY_STORAGE);
      if (!saved) return;
      adminKey = saved;
      loginCard.style.display = 'none';
      panel.style.display = 'block';
      refreshAll().catch(() => {
        logout();
      });
    })();
  </script>
</body>

</html>
